#include "quantum.h"
#include "qmk_midi.h"
#include "midi-feedback.h"

/* Stores the last velocity of each note sent to the keyboard. */
char indicators[CLIP_BLOCK_X * CLIP_BLOCK_Y];

void midi_noteon_callback(MidiDevice *device, uint8_t byte0, uint8_t byte1, uint8_t byte2)
{
	if (byte1 >= CLIP_BLOCK_INITIAL_NOTE && byte1 < CLIP_BLOCK_INITIAL_NOTE + CLIP_BLOCK_X * CLIP_BLOCK_Y)
	{
		indicators[byte1 - CLIP_BLOCK_INITIAL_NOTE] = byte2;
		dprintf("MIDI indicator %u velocity %u. Set index %u\n", byte1, byte2, byte1 - CLIP_BLOCK_INITIAL_NOTE);
	}
}

/* It seems this is not actually called, noteon with velocity 0 is used instead. Implemented just in case. */
void midi_noteoff_callback(MidiDevice *device, uint8_t byte0, uint8_t byte1, uint8_t byte2)
{
	if (byte1 >= CLIP_BLOCK_INITIAL_NOTE && byte1 < CLIP_BLOCK_INITIAL_NOTE + CLIP_BLOCK_X * CLIP_BLOCK_Y)
	{
		indicators[byte1 - CLIP_BLOCK_INITIAL_NOTE] = 0;
	}
}

void keyboard_post_init_user(void) {
	midi_register_noteon_callback(&midi_device, midi_noteon_callback);
	midi_register_noteoff_callback(&midi_device, midi_noteoff_callback);
}

/* RGB values for colors used by Ableton Live. */
const uint8_t ableton_colors[] =
{
	0x0, 0x0, 0x0,
	0x1e, 0x1e, 0x1e,
	0x7f, 0x7f, 0x7f,
	0xff, 0xff, 0xff,
	0xff, 0x4c, 0x4c,
	0xff, 0x0, 0x0,
	0x59, 0x0, 0x0,
	0x19, 0x0, 0x0,
	0xff, 0xbd, 0x6c,
	0xff, 0x54, 0x0,
	0x59, 0x1d, 0x0,
	0x27, 0x1b, 0x0,
	0xff, 0xff, 0x4c,
	0xff, 0xff, 0x0,
	0x59, 0x59, 0x0,
	0x19, 0x19, 0x0,
	0x88, 0xff, 0x4c,
	0x54, 0xff, 0x0,
	0x1d, 0x59, 0x0,
	0x14, 0x2b, 0x0,
	0x4c, 0xff, 0x4c,
	0x0, 0xff, 0x0,
	0x0, 0x59, 0x0,
	0x0, 0x19, 0x0,
	0x4c, 0xff, 0x5e,
	0x0, 0xff, 0x19,
	0x0, 0x59, 0xd,
	0x0, 0x19, 0x2,
	0x4c, 0xff, 0x88,
	0x0, 0xff, 0x55,
	0x0, 0x59, 0x1d,
	0x0, 0x1f, 0x12,
	0x4c, 0xff, 0xb7,
	0x0, 0xff, 0x99,
	0x0, 0x59, 0x35,
	0x0, 0x19, 0x12,
	0x4c, 0xc3, 0xff,
	0x0, 0xa9, 0xff,
	0x0, 0x41, 0x52,
	0x0, 0x10, 0x19,
	0x4c, 0x88, 0xff,
	0x0, 0x55, 0xff,
	0x0, 0x1d, 0x59,
	0x0, 0x8, 0x19,
	0x4c, 0x4c, 0xff,
	0x0, 0x0, 0xff,
	0x0, 0x0, 0x59,
	0x0, 0x0, 0x19,
	0x87, 0x4c, 0xff,
	0x54, 0x0, 0xff,
	0x19, 0x0, 0x64,
	0xf, 0x0, 0x30,
	0xff, 0x4c, 0xff,
	0xff, 0x0, 0xff,
	0x59, 0x0, 0x59,
	0x19, 0x0, 0x19,
	0xff, 0x4c, 0x87,
	0xff, 0x0, 0x54,
	0x59, 0x0, 0x1d,
	0x22, 0x0, 0x13,
	0xff, 0x15, 0x0,
	0x99, 0x35, 0x0,
	0x79, 0x51, 0x0,
	0x43, 0x64, 0x0,
	0x3, 0x39, 0x0,
	0x0, 0x57, 0x35,
	0x0, 0x54, 0x7f,
	0x0, 0x0, 0xff,
	0x0, 0x45, 0x4f,
	0x25, 0x0, 0xcc,
	0x7f, 0x7f, 0x7f,
	0x20, 0x20, 0x20,
	0xff, 0x0, 0x0,
	0xbd, 0xff, 0x2d,
	0xaf, 0xed, 0x6,
	0x64, 0xff, 0x9,
	0x10, 0x8b, 0x0,
	0x0, 0xff, 0x87,
	0x0, 0xa9, 0xff,
	0x0, 0x2a, 0xff,
	0x3f, 0x0, 0xff,
	0x7a, 0x0, 0xff,
	0xb2, 0x1a, 0x7d,
	0x40, 0x21, 0x0,
	0xff, 0x4a, 0x0,
	0x88, 0xe1, 0x6,
	0x72, 0xff, 0x15,
	0x0, 0xff, 0x0,
	0x3b, 0xff, 0x26,
	0x59, 0xff, 0x71,
	0x38, 0xff, 0xcc,
	0x5b, 0x8a, 0xff,
	0x31, 0x51, 0xc6,
	0x87, 0x7f, 0xe9,
	0xd3, 0x1d, 0xff,
	0xff, 0x0, 0x5d,
	0xff, 0x7f, 0x0,
	0xb9, 0xb0, 0x0,
	0x90, 0xff, 0x0,
	0x83, 0x5d, 0x7,
	0x39, 0x2b, 0x0,
	0x14, 0x4c, 0x10,
	0xd, 0x50, 0x38,
	0x15, 0x15, 0x2a,
	0x16, 0x20, 0x5a,
	0x69, 0x3c, 0x1c,
	0xa8, 0x0, 0xa,
	0xde, 0x51, 0x3d,
	0xd8, 0x6a, 0x1c,
	0xff, 0xe1, 0x26,
	0x9e, 0xe1, 0x2f,
	0x67, 0xb5, 0xf,
	0x1e, 0x1e, 0x30,
	0xdc, 0xff, 0x6b,
	0x80, 0xff, 0xbd,
	0x9a, 0x99, 0xff,
	0x8e, 0x66, 0xff,
	0x40, 0x40, 0x40,
	0x75, 0x75, 0x75,
	0xe0, 0xff, 0xff,
	0xa0, 0x0, 0x0,
	0x35, 0x0, 0x0,
	0x1a, 0xd0, 0x0,
	0x7, 0x42, 0x0,
	0xb9, 0xb0, 0x0,
	0x3f, 0x31, 0x0,
	0xb3, 0x5f, 0x0,
	0x4b, 0x15, 0x2
};